     1                                  ;haribote-os
     2                                  ;TAB = 4
     3                                  
     4                                  BOTPAK	EQU	0x00280000
     5                                  DSKCAC	EQU	0x00100000
     6                                  DSKCAC0	EQU	0x00008000
     7                                  ; 有关BOOT_INFO
     8                                  CYLS	EQU	0x0ff0		;	设定启动区
     9                                  LEDS	EQU	0x0ff1
    10                                  VMODE	EQU	0x0ff2		;	关于颜色数目的信息，颜色的位数
    11                                  SCRNX	EQU	0x0ff4		;	分辨率的X
    12                                  SCRNY	EQU	0x0ff6		; 分辨率的Y
    13                                  VRAM	EQU	0x0ff8		;	图像缓冲区的开始地址
    14                                  
    15                                  	ORG 0xc400				; 程序装载到内存的位置
    16                                  	
    17 00000000 B013                    	mov	AL,0x13			;VGA 显卡，320x200x8 位彩色
    18 00000002 B400                    	mov	AH,0x00
    19 00000004 CD10                    	INT 0x10
    20 00000006 C606F20F08              	mov	BYTE [VMODE],	8	; 记录画面模式
    21 0000000B C706F40F4001            	mov	WORD [SCRNX], 320;
    22 00000011 C706F60FC800            	mov	WORD [SCRNY], 200;
    23 00000017 66C706F80F00000A00      	mov	DWORD [VRAM], 0x000a0000
    24                                  
    25                                  ; 用BIOS取得键盘上各种欧冠你LED指示灯的状态
    26 00000020 B402                    	mov	AH, 0x02
    27 00000022 CD16                    	INT	0x16						; KeyBoard BIOS
    28 00000024 A2F10F                  	mov [LEDS], AL
    29                                  ;PCI 关闭一切中断
    30                                  ;根据AT兼容机的规格，如果要初始化PIC必须在CLI之前进行
    31                                  ;否则有时会挂起，随后进行PIC的初始化
    32 00000027 B0FF                    	mov	AL,	0xff
    33 00000029 E621                    	out	0x21,	AL
    34 0000002B 90                      	NOP									;如果连续执行out指令，有些机种会无法正常运行
    35 0000002C E6A1                    	out	0xa1,	AL
    36 0000002E FA                      	CLI 								;禁止CPU级别的中断
    37                                  
    38                                  ;为了让CPU能够访问1MB以上的内存空间，设定A20GATE
    39 0000002F E8B500                  	call waitkbdout
    40 00000032 B0D1                    	mov	AL,	0xd1
    41 00000034 E664                    	out	0x64,	AL
    42 00000036 E8AE00                  	call waitkbdout
    43 00000039 B0DF                    	mov	AL,	0xdf
    44 0000003B E660                    	out	0x60,	AL
    45 0000003D E8A700                  	call waitkbdout
    46                                  
    47                                  ;切换到保护模式
    48                                  ;[INSTRSET "i4860"]
    49 00000040 0F0116[2A01]            	LGDT	[GDTR0]										;设定临时GDT
    50 00000045 0F20C0                  	mov	EAX,	CR0
    51 00000048 6625FFFFFF7F            	and	EAX,	0x7fffffff						;	设bit31为0(为了禁止颁)
    52 0000004E 6683C801                	or	EAX,	0x00000001						;	设bit0为1(为了切换到保护模式)
    53 00000052 0F22C0                  	mov	CR0,	EAX
    54 00000055 EB00                    	jmp	pipelineflush
    55                                  
    56                                  pipelineflush:
    57 00000057 B80800                  	mov	AX,	1*8											;	可读写的段 32bit
    58 0000005A 8ED8                    	mov	DS,	AX
    59 0000005C 8EC0                    	mov	ES,	AX
    60 0000005E 8EE0                    	mov	FS,	AX
    61 00000060 8EE8                    	mov	GS,	AX
    62 00000062 8ED0                    	mov	SS,	AX
    63                                  
    64                                  
    65                                  ;	bootpack的转送
    66 00000064 66BE[30010000]          	mov	ESI,	bootpack
    67 0000006A 66BF00002800            	mov	EDI,	BOTPAK
    68 00000070 66B900000200            	mov	ECX,	512*1024/4
    69 00000076 E87500                  	call	memcpy
    70                                  
    71                                  ;	磁盘数据最终转送到它本来的位置去
    72                                  ;	首先从启动扇区开始
    73 00000079 66BE007C0000            	mov	ESI,	0x7c00										;	转送源
    74 0000007F 66BF00001000            	mov	EDI,	DSKCAC										;	转送目的地
    75 00000085 66B980000000            	mov	ECX,	512/4
    76 0000008B E86000                  	call	memcpy
    77                                  
    78                                  ;	所有剩下的
    79 0000008E 66BE00820000            	mov	ESI,	DSKCAC0+512								;	转送源
    80 00000094 66BF00021000            	mov	EDI,	DSKCAC+512								;	转送目的地
    81 0000009A 66B900000000            	mov	ECX,	0
    82 000000A0 8A0EF00F                	mov	CL,		BYTE	[CYLS]
    83 000000A4 6669C900120000          	imul	ECX,	512*18*2/4							;	从柱面数变为字节数/4
    84 000000AB 6681E980000000          	sub	ECX,	512/4											;	减去	IPL
    85 000000B2 E83900                  	call	memcpy
    86                                  
    87                                  ;	必须由asmhead来完成的工作，至此全部完毕，以后就交给bootpack来完成
    88                                  
    89                                  ;	bootpack的启动
    90 000000B5 66BB00002800            	mov	EBX,	BOTPAK
    91 000000BB 66678B4B10              	mov	ECX,	[EBX+16]
    92 000000C0 6683C103                	add	ECX,	3								; ECX +=3
    93 000000C4 66C1E902                	SHR	ECX,	2								; ECX	/=2
    94 000000C8 7410                    	jz	skip
    95 000000CA 66678B7314              	mov	ESI,	[EBX+20]									;	转送源
    96 000000CF 6601DE                  	add	ESI,	EBX
    97 000000D2 66678B7B0C              	mov	EDI,	[EBX+12]									;	转送目的地
    98 000000D7 E81400                  	call	memcpy
    99                                  
   100                                  skip:
   101 000000DA 66678B630C              	mov	ESP,	[EBX+12]
   102 000000DF 66EA1B0000001000        	jmp	DWORD 2*8:0x0000001b
   103                                  
   104                                  waitkbdout
   104          ******************       warning: label alone on a line without a colon might be in error
   105 000000E7 E464                    	in	AL,	0x64
   106 000000E9 2402                    	and	AL,	0x02
   107 000000EB 75FA                    	jnz	waitkbdout												;	AND 的结果不是0,就跳转到waitkbdout
   108 000000ED C3                      	RET
   109                                  
   110                                  memcpy:
   111 000000EE 66678B06                	mov	EAX,	[ESI]
   112 000000F2 6683C604                	add	ESI,	4
   113 000000F6 66678907                	mov	[EDI],	EAX
   114 000000FA 6683C704                	add	EDI,	4
   115 000000FE 6683E901                	sub	ECX,	1
   116 00000102 75EA                    	jnz	memcpy														;	减法运算的结果如果不是0,就跳转到memcpy
   117 00000104 C3                      	RET
   118                                  	
   119 00000105 <res 0000000B>          	ALIGNB	16
   119          ******************       warning: uninitialized space declared in .text section: zeroing
   120                                  
   121                                  GDT0:
   122 00000110 <res 00000008>          	RESB	8																; NULL selector
   122          ******************       warning: uninitialized space declared in .text section: zeroing
   123 00000118 FFFF00000092CF00        	DW	0xffff,	0x0000,	0x9200,	0x00cf		;	可以读写的段(segment) 32bit
   124 00000120 FFFF0000289A4700        	DW	0xffff,	0x0000,	0x9a28,	0x0047		;	可以执行的段(segment) 32bit(bootpack 用)
   125                                  	
   126 00000128 0000                    	DW	0
   127                                  
   128                                  GDTR0:
   129 0000012A 1700                    	DW	8*3-1
   130 0000012C [10010000]              	DD	GDT0
   131                                  	ALIGNB	16
   132                                  
   133                                  bootpack:
   134                                  	
   135                                  
